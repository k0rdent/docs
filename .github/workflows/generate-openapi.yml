name: Generate OpenAPI Spec

on:
  workflow_dispatch:
    inputs:
      kcm_ref:
        description: 'kcm repo ref (tag like v1.5.0, or branch like main)'
        required: true
        default: 'main'
      docs_branch:
        description: 'Docs branch to commit to'
        required: true
        default: 'main'
  repository_dispatch:
    types: [kcm-crd-update]

permissions:
  contents: write
  pull-requests: write

jobs:
  generate:
    runs-on: ubuntu-latest
    steps:
      - name: Determine refs
        id: refs
        run: |
          set -euo pipefail

          if [ "${{ github.event_name }}" = "repository_dispatch" ]; then
            # Triggered from kcm repo
            RAW_KCM_REF="${{ github.event.client_payload.ref }}"
            RAW_DOCS_BRANCH="${{ github.event.client_payload.docs_branch }}"
          else
            # Manual trigger
            RAW_KCM_REF="${{ github.event.inputs.kcm_ref }}"
            RAW_DOCS_BRANCH="${{ github.event.inputs.docs_branch }}"
          fi

          if [ -z "${RAW_DOCS_BRANCH:-}" ]; then
            RAW_DOCS_BRANCH="main"
          fi

            # Normalize refs (strip refs/heads|tags prefixes)
            KCM_REF="${RAW_KCM_REF#refs/heads/}"
            KCM_REF="${KCM_REF#refs/tags/}"
            KCM_REF="${KCM_REF#refs/}"
            DOCS_BRANCH="$RAW_DOCS_BRANCH"

          if [ -z "$KCM_REF" ]; then
            echo "ERROR: kcm_ref is empty after normalization"
            exit 1
          fi

          # Determine version string for filename
          if [[ "$KCM_REF" == "main" ]]; then
            VERSION_STRING="main"
          elif [[ "$KCM_REF" =~ ^v?([0-9]+\.[0-9]+\.[0-9]+)$ ]]; then
            VERSION_STRING="${BASH_REMATCH[1]}"
          else
            VERSION_STRING="$KCM_REF"
          fi

          echo "kcm_ref=$KCM_REF" >> $GITHUB_OUTPUT
          echo "docs_branch=$DOCS_BRANCH" >> $GITHUB_OUTPUT
          echo "version_string=$VERSION_STRING" >> $GITHUB_OUTPUT

          echo "KCM ref: $KCM_REF"
          echo "Docs branch: $DOCS_BRANCH"
          echo "Version string: $VERSION_STRING"

      - name: Verify docs branch exists
        run: |
          if ! git ls-remote --heads https://github.com/${{ github.repository }} "${{ steps.refs.outputs.docs_branch }}" | grep -q .; then
            echo "ERROR: Docs branch '${{ steps.refs.outputs.docs_branch }}' not found in repo"
            exit 1
          fi

      - name: Checkout docs repo
        uses: actions/checkout@v4
        with:
          ref: ${{ steps.refs.outputs.docs_branch }}

      - name: Clone kcm repo
        run: |
          KCM_REF="${{ steps.refs.outputs.kcm_ref }}"

          # Clone with minimal depth, then fetch the specific ref we need
          git clone --depth 1 --no-single-branch https://github.com/k0rdent/kcm /tmp/kcm-repo
          cd /tmp/kcm-repo

          # Fetch all tags (shallow)
          git fetch --tags --depth 1

          # Try to checkout the ref
          if git rev-parse "refs/tags/${KCM_REF}" >/dev/null 2>&1; then
            echo "Checking out tag: ${KCM_REF}"
            git checkout "tags/${KCM_REF}" --force
          elif git show-ref --verify --quiet "refs/remotes/origin/${KCM_REF}"; then
            echo "Checking out branch: ${KCM_REF}"
            git checkout "${KCM_REF}" --force
          elif git fetch origin "${KCM_REF}" --depth 1 2>/dev/null; then
            echo "Fetched and checking out: ${KCM_REF}"
            git checkout FETCH_HEAD --force
          else
            echo "ERROR: ref ${KCM_REF} not found in k0rdent/kcm"
            exit 1
          fi

          echo "Checked out $(git rev-parse HEAD)"

      - name: Set up Kind
        uses: helm/kind-action@v1.10.0
        with:
          cluster_name: openapi-gen
          wait: 60s

      - name: Install CRDs
        run: |
          kubectl --context kind-openapi-gen apply -f /tmp/kcm-repo/templates/provider/kcm/templates/crds/

          echo "Waiting for CRDs to be established..."
          crds=$(kubectl --context kind-openapi-gen get crd -o name | grep "k0rdent\.mirantis\.com" || true)
          if [ -n "$crds" ]; then
            echo "$crds" | xargs -r -n1 -I{} kubectl --context kind-openapi-gen wait --for=condition=Established --timeout=180s {}
          fi

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Extract OpenAPI spec
        run: |
          VERSION_STRING="${{ steps.refs.outputs.version_string }}"
          OUTPUT_FILE="docs/openapi/k0rdent-api-${VERSION_STRING}.json"

          mkdir -p docs/openapi

          echo "Discovering k0rdent API versions..."
          api_versions=$(kubectl --context kind-openapi-gen api-versions | grep "^k0rdent.mirantis.com/" | sort || true)

          if [ -z "$api_versions" ]; then
            echo "ERROR: No k0rdent.mirantis.com API versions found"
            exit 1
          fi

          echo "Found: $api_versions"

          # Extract spec for each version
          temp_dir=$(mktemp -d)
          extracted_files=()

          for api_version in $api_versions; do
            safe_name=$(echo "$api_version" | tr '/' '-' | tr '.' '-')
            version_file="${temp_dir}/${safe_name}.json"
            echo "Extracting ${api_version}..."

            for attempt in $(seq 1 10); do
              if kubectl --context kind-openapi-gen get --raw "/openapi/v3/apis/${api_version}" > "${version_file}" 2>/dev/null; then
                if jq empty "${version_file}" 2>/dev/null; then
                  echo "  âœ“ Extracted successfully"
                  extracted_files+=("${version_file}")
                  break
                fi
              fi
              sleep 3
            done
          done

          if [ ${#extracted_files[@]} -eq 0 ]; then
            echo "ERROR: Failed to extract any OpenAPI specs"
            exit 1
          fi

          # Use first file as base, merge others
          first_file="${extracted_files[0]}"
          jq --arg ver "${VERSION_STRING}" \
            '.info.title = "k0rdent APIs" | .info.version = $ver | .info.description = "OpenAPI specification for k0rdent APIs (k0rdent.mirantis.com)"' \
            "${first_file}" > "${OUTPUT_FILE}"

          for spec_file in "${extracted_files[@]:1}"; do
            echo "Merging: $(basename "$spec_file")"
            temp_merged="${OUTPUT_FILE}.tmp"
            jq -s '
              .[0].paths = (.[0].paths + .[1].paths) |
              .[0].components = (.[0].components + .[1].components) |
              .[0]
            ' \
              "${OUTPUT_FILE}" "${spec_file}" > "${temp_merged}" && mv "${temp_merged}" "${OUTPUT_FILE}"
          done

          rm -rf "$temp_dir"

          echo "Generated: ${OUTPUT_FILE}"
          ls -lh "${OUTPUT_FILE}"
          jq '.info' "${OUTPUT_FILE}"

      - name: Update api-specification index
        run: |
          VERSION_STRING="${{ steps.refs.outputs.version_string }}"
          if [ -f "docs/api-specification/index.md" ]; then
            sed -i "s|k0rdent-api-[0-9a-zA-Z.-]*\.json|k0rdent-api-${VERSION_STRING}.json|g" docs/api-specification/index.md
            echo "Updated api-specification/index.md"
          fi

      - name: Create PR with changes
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          VERSION_STRING="${{ steps.refs.outputs.version_string }}"
          KCM_REF="${{ steps.refs.outputs.kcm_ref }}"
          DOCS_BRANCH="${{ steps.refs.outputs.docs_branch }}"
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          PR_BRANCH="openapi-update-${VERSION_STRING}-${TIMESTAMP}"

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add docs/openapi/ docs/api-specification/

          if git diff --staged --quiet; then
            echo "No changes to commit"
            exit 0
          fi

          # Create a new branch and commit
          git checkout -B "$PR_BRANCH"
          git commit -m "Update OpenAPI spec from kcm ${KCM_REF}"
          git push --force-with-lease origin "$PR_BRANCH"

          # Create PR body file to avoid YAML parsing issues
          cat > /tmp/pr_body.md << EOF
          This PR updates the OpenAPI specification extracted from k0rdent/kcm ref \`${KCM_REF}\`.

          **Changes:**
          - Updated \`docs/openapi/k0rdent-api-${VERSION_STRING}.json\`
          - Updated \`docs/api-specification/index.md\` to reference the new spec

          **Source:** https://github.com/k0rdent/kcm/tree/${KCM_REF}

          ---
          *This PR was automatically generated by the Generate OpenAPI Spec workflow.*
          EOF

          gh pr create \
            --base "$DOCS_BRANCH" \
            --head "$PR_BRANCH" \
            --title "Update OpenAPI spec from kcm ${KCM_REF}" \
            --body-file /tmp/pr_body.md

          echo "--- PR created for OpenAPI spec update ---"

      - name: Cleanup Kind cluster
        if: always()
        run: kind delete cluster --name openapi-gen || true
